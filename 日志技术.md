# 日志技术

日志是用来干什么的？

- 调试与问题排查
- 监控系统运行状态（如资源使用情况）
- 性能分析与优化（可以发现耗时的操作）
- 灾难恢复与回溯
- 数据追踪

实践原则：

- 分级记录：使用合适的日志级别
- 避免敏感信息
- 结构化输出
- 上下文关联
- 性能友好：避免字符串拼接，异步写入

现代推荐的日志实践：slf4j+logback/log4j2，注意区分slf4j只是提供了统一的接口（门面模式），并不负责日志技术的真正实现，logback/log4j2才是真正的日志框架，负责日志的实现



## LogBack

springboot项目默认使用slf4j+logback作为日志实现，并且`spring-boot-starter`中包含了这两个依赖，所以所有继承了`spring-bbot-starter`的依赖都将默认包含它们，因此我们不需要额外引入，直接使用即可



使用：获取Logger后直接使用即可，但是**默认日志级别是INFO**

~~~java
package org.wuming.controller;

import org.springframework.stereotype.Controller;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;


@Controller
public class LogController {
    // 注意此处需要根据使用的类获取对应的Logger
    private static final Logger log = LoggerFactory.getLogger(LogController.class);

    @RequestMapping("/hello")
    @ResponseBody
    public String hello() {
        // 此处如果不修改日志级别，则上面两条语句的输出不会打印在控制台
        log.trace("hello");
        log.info("hello");
        
        log.debug("hello");
        return "hello";
    }
}
~~~

如果引入了LomBok依赖则可以：

~~~java
package org.wuming.controller;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

@Slf4j
@Controller
public class LogController {

    @RequestMapping("/hello")
    @ResponseBody
    public String hello() {
        log.trace("hello");
        log.info("hello");
        log.debug("hello");
        return "hello";
    }
}
~~~



日志配置文件详解：

常用的两种输出日志的位置：控制台、文件

~~~xml
<!--控制台输出-->
<appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">...</appender>

<!--文件输出-->
<appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
	...
</appender>
~~~

指定输出日志的级别和输出位置：

~~~xml
<!--如果此处为debug，则日志级别大于等于debug的才会输出-->
<root level="ALL">	<!--这里就是指定什么级别的日志才会输出-->
	<appender-ref ref="STDOUT"/>
    <appender-ref ref="FILE"/>
</root>
~~~

日志级别：
- trace
- debug：调试，实际应用中一般视作最低级别
- info
- warn
- error

典型的配置文件：

~~~xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- 控制台输出 -->
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- 文件输出（带滚动） -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <!--必须添加 <file> 指向当前日志文件 -->
        <file>./logs/tlias.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <!-- 归档文件名格式 -->
            <fileNamePattern>./logs/tlias-%d{yyyy-MM-dd}-%i.log</fileNamePattern>
            <!-- 保留30天 -->
            <maxHistory>30</maxHistory>
            <!-- 单个文件最大10MB -->
            <maxFileSize>10MB</maxFileSize>
            <!-- 可选：总日志大小上限 -->
            <!-- <totalSizeCap>1GB</totalSizeCap> -->
        </rollingPolicy>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- 根日志级别 -->
    <root level="INFO">
        <appender-ref ref="STDOUT"/>
        <appender-ref ref="FILE"/>
    </root>
</configuration>
~~~



上述文件可以命名为logback.xml，放在resources目录下，spring会自动扫描，当然也可以随意命名，最后在配置文件中声明`logging.config=_`即可，不过如果命名为logback-spring.xml是官方推荐的选择




| 特性                                                 | `logback.xml`                               | `logback-spring.xml`                                      |
| ---------------------------------------------------- | ------------------------------------------- | --------------------------------------------------------- |
| **加载方式**                                         | 由 Logback 原生加载（在 Spring 容器启动前） | 由 Spring Boot 延迟加载（在 Spring Environment 初始化后） |
| **是否支持 Spring Profile**                          | 不支持                                      | 支持 `<springProfile>` 标签                                              |
| **是否支持 Spring 属性占位符** （如 `${LOG_PATH}`）  | 不支持 （`${}` 会被当作普通字符串）         | 支持 （可通过 `<springProperty>` 或直接使用 `${}`）     |
| **是否受 `application.yml` 中 `logging.level` 影响** | 基本不受影响（加载更早）                    | 会受影响（Spring Boot 会覆盖级别）                        |
| **推荐使用场景**                                     | 纯 Logback 项目，或不需要 Spring 集成       | **Spring Boot 项目（官方推荐）**                          |

1

springboot项目中logback-spring.xml典型配置：

~~~xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="true" scanPeriod="30 seconds">
    <!-- 引入 Spring 环境变量，这里的source即引用配置文件中的值 -->
    <springProperty scope="context" name="APP_NAME" source="spring.application.name" defaultValue="myapp"/>
    <springProperty scope="context" name="LOG_PATH" source="logging.file.path" defaultValue="./logs"/>
    <springProperty scope="context" name="LOG_FILE" source="logging.file.name" defaultValue="${LOG_PATH}/${APP_NAME}.log"/>

    <!-- 控制台 Appender（开发环境使用） -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr(${LOG_LEVEL_PATTERN:-%5p}) %clr(${PID:- }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- 文件 Appender（带滚动策略） -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE}</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <!-- 日志文件名格式：app.log.2025-11-24.0.gz -->
            <fileNamePattern>${LOG_FILE}.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <!-- 单个文件最大 100MB -->
            <maxFileSize>100MB</maxFileSize>
            <!-- 保留 30 天日志 -->
            <maxHistory>30</maxHistory>
            <!-- 总日志大小不超过 10GB -->
            <totalSizeCap>10GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{40} - %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- 异步 Appender（可选，提升性能） -->
    <!--
    <appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="FILE"/>
        <queueSize>1024</queueSize>
        <discardingThreshold>0</discardingThreshold>
    </appender>
    -->

    <!-- 开发环境：输出到控制台，DEBUG 级别 -->
    <springProfile name="dev">
        <root level="DEBUG">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <!-- 测试环境 -->
    <springProfile name="test">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
        </root>
    </springProfile>

    <!-- 生产环境：只输出到文件，WARN 级别 -->
    <springProfile name="prod">
        <root level="WARN">
            <appender-ref ref="FILE"/>
        </root>
        <!-- 特定包可设为 INFO -->
        <logger name="com.yourcompany" level="INFO"/>
    </springProfile>

    <!-- 默认配置（当未激活任何 profile 时） -->
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE"/>
    </root>

</configuration>
~~~





## Log4j2

排除logback，引入log4j2依赖

~~~xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-webmvc</artifactId>
    <exclusions>
        <exclusion>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-logging</artifactId>
        </exclusion>
    </exclusions>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-log4j2</artifactId>
</dependency>
~~~



然后java代码在slf4j（门面模式）的作用下与logback没有区别，可以直接使用日志功能了

如果需要额外配置，则定义log4j2-spring.xml：

~~~xml
<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="WARN" monitorInterval="30">
    <!-- 定义变量：可通过 Spring 属性覆盖 -->
    <Properties>
        <!-- 默认日志路径，可通过 application.yml 中的 logging.file.path 覆盖 -->
        <Property name="LOG_PATH">./logs</Property>
        <Property name="FILE_NAME">${LOG_PATH}/tlias.log</Property>
        <Property name="PATTERN">%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5level %logger{50} - %msg%n</Property>
    </Properties>

    <Appenders>
        <!-- 控制台 Appender -->
        <Console name="STDOUT" target="SYSTEM_OUT">
            <PatternLayout pattern="${PATTERN}" charset="UTF-8"/>
        </Console>

        <!-- 滚动文件 Appender -->
        <RollingFile name="FILE" fileName="${FILE_NAME}"
                     filePattern="${LOG_PATH}/tlias-%d{yyyy-MM-dd}-%i.log.gz">
            <PatternLayout pattern="${PATTERN}" charset="UTF-8"/>
            <Policies>
                <!-- 按天滚动 -->
                <TimeBasedTriggeringPolicy interval="1"/>
                <!-- 按大小滚动（10MB） -->
                <SizeBasedTriggeringPolicy size="10MB"/>
            </Policies>
            <!-- 最多保留 30 个归档文件（约 30 天） -->
            <DefaultRolloverStrategy max="30"/>
        </RollingFile>
    </Appenders>

    <Loggers>
        <!-- 根 Logger -->
        <Root level="info">
            <AppenderRef ref="STDOUT"/>
            <AppenderRef ref="FILE"/>
        </Root>
    </Loggers>
</Configuration>
~~~


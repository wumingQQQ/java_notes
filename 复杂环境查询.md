# 复杂环境查询

原因：不同实体类的字段之间存在关联，需要使用嵌套对象而非普通类型，例如导师与研究生，研究生字段中不能仅有一个导师id，这无法说明二者关联，甚至该id对应大=的导师可能不存在，关联字段必须为导师对象才能说明关联性，增删改查的复杂性也源于这些关联，必须联表操作。

## 多对一的处理

以导师学生为例：

~~~java
package org.wuming.pojo;

import lombok.Data;

@Data
public class Student {
    private int id;
    private String name;

    //关联一个老师
    private Teacher teacher;
}
~~~



### 方式一（子查询）

1. 查询出学生信息
2. 根据学生表中的关联字段查询对应老师信息

~~~xml
	<select id="getStudent" resultMap="s-t">
        select * from student
    </select>
    <resultMap id="s-t" type="Student">
        <result column="id" property="id"/>
        <result column="name" property="name"/>
    <!--结果集映射时复杂的属性需要单独处理， 对象：association， 集合：collection -->
        <!--javaType指定属性所属的类，select指定方法-->
        <association property="teacher" column="tid" javaType="teacher" select="getTeacher"/>
    </resultMap>
    
	<!--无需在接口中定义-->	
<!--    下面的#{id}中的id可以改成任何名字，因为只有一个参数，会自行匹配-->
    <select id="getTeacher" resultType="Teacher">
        select * from teacher where id=#{id}
    </select>
~~~

### 方式二（结果集嵌套）

~~~xml
	<select id="getStudent2" resultMap="s-t2">
        select s.id sid, s.name sName, t.id tid, t.name tName
        from student s, teacher t where s.tid=t.id
    </select>
    <resultMap id="s-t2" type="Student">
        <result property="id" column="sid"/>
        <result property="name" column="sName"/>
        
        <!--嵌套映射-->
        <association property="teacher" javaType="teacher">
            <result property="id" column="tid"/>
            <result property="name" column="tName"/>
        </association>
    </resultMap>
~~~



## 一对多的处理

同样以导师学生为例

~~~java
package org.wuming.pojo;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class Teacher {
    private int id;
    private String name;

    private List<Student> students;
}
~~~

### 方式一（子查询，关联查询）

~~~xml
	<select id="getTeacher2" resultMap="s-t2">
        select * from teacher
    </select>
    <resultMap id="s-t2" type="Teacher">
        <!--需要指定javaType和ofType-->
        <!--由于是分开查询，需要在执行关联查询前就知道用什么集合类型存储结果-->
       <collection property="students" column="id" javaType="ArrayList" ofType="student" select="getStudent"/>
    </resultMap>
    <select id="getStudent" resultType="student">
        select * from student where tid=#{tid}
    </select>
~~~







### 方式二（结果集嵌套，联表查询）

~~~xml
	<!--单次查询出全部结果-->
	<select id="getTeacher" resultMap="s-t">
        select s.id sid, s.name sname, t.id tid, t.name tname
        from teacher t, student s
        where t.id=#{id} and s.tid=t.id
    </select>
    <resultMap id="s-t" type="teacher">
        <result property="id" column="tid"/>
        <result property="name" column="tname"/>
        <!--属性为集合时使用collection，使用ofType指定泛型类型-->
        <!--javaType将由通过反射读取students类型-->
        <collection property="students" ofType="student">
            <result property="id" column="sid"/>
            <result property="name" column="sname"/>
            <result property="tid" column="tid"/>
        </collection>
    </resultMap>
~~~

